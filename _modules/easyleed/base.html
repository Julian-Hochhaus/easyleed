

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>EasyLEED: LEED I(E)-spectra analysis &#8212; EasyLEED 2.5 documentation</title>
    <link rel="stylesheet" href="../../_static/easyleed.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/print.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/theme_extras.js"></script>
    <link rel="shortcut icon" href="../../_static/icon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body>
      <div class="header">
        <a href="../../index.html">
          <img class="logo" src="../../_static/logo.png" alt="Logo"/>
        </a>
      </div>
      <div class="topnav">
      

      </div>
      
      <div class="content">
        <div class="documentwrapper">
            <div class="body">
                
  <h1>Source code for easyleed.base</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">easyleed.base</span>
<span class="sd">-------------</span>

<span class="sd">Base class providing common functionality for analyzing Leed patterns.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">optimize</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">kalman</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">logger</span>


<div class="viewcode-block" id="SpotModel"><a class="viewcode-back" href="../../api.html#easyleed.base.SpotModel">[docs]</a><span class="k">class</span> <span class="nc">SpotModel</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Data model for a Spot that stores all the information in various lists.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span></div>


<div class="viewcode-block" id="Tracker"><a class="viewcode-back" href="../../api.html#easyleed.base.Tracker">[docs]</a><span class="k">class</span> <span class="nc">Tracker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Tracks spots through intensity information and velocity prediction. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_in</span><span class="p">,</span> <span class="n">y_in</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">x_c</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y_c</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">input_precision</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">window_scaling</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; x_in, y_in: start position of spot &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">radius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_tracker</span><span class="p">(</span><span class="n">x_in</span><span class="p">,</span> <span class="n">y_in</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">x_c</span><span class="p">,</span> <span class="n">y_c</span><span class="p">,</span>
            <span class="n">input_precision</span><span class="p">,</span> <span class="n">window_scaling</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">init_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_in</span><span class="p">,</span> <span class="n">y_in</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">x_c</span><span class="p">,</span> <span class="n">y_c</span><span class="p">,</span>
            <span class="n">input_precision</span><span class="p">,</span> <span class="n">window_scaling</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x_c</span> <span class="ow">and</span> <span class="n">y_c</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">x_in</span> <span class="o">-</span> <span class="n">x_c</span><span class="p">,</span> <span class="n">y_in</span> <span class="o">-</span> <span class="n">y_c</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**.</span><span class="mi">5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">/</span> <span class="n">energy</span>
            <span class="c1"># calculate std. dev. of velocity guess</span>
            <span class="c1"># by propagation of uncertainty from the input precision</span>
            <span class="n">v_precision</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**.</span><span class="mi">5</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">input_precision</span> <span class="o">/</span> <span class="n">energy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="n">cov_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="n">input_precision</span><span class="p">,</span> <span class="n">input_precision</span><span class="p">,</span> <span class="n">v_precision</span><span class="p">,</span> <span class="n">v_precision</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kalman</span> <span class="o">=</span> <span class="n">kalman</span><span class="o">.</span><span class="n">PVKalmanFilter2</span><span class="p">(</span><span class="n">x_in</span><span class="p">,</span> <span class="n">y_in</span><span class="p">,</span> <span class="n">cov_input</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">vx_in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">),</span> <span class="n">vy_in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cov_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="n">input_precision</span><span class="p">,</span> <span class="n">input_precision</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kalman</span> <span class="o">=</span> <span class="n">kalman</span><span class="o">.</span><span class="n">PVKalmanFilter2</span><span class="p">(</span><span class="n">x_in</span><span class="p">,</span> <span class="n">y_in</span><span class="p">,</span> <span class="n">cov_input</span><span class="p">,</span> <span class="n">energy</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">window_scaling</span> <span class="o">=</span> <span class="n">window_scaling</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_scaling</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c_size</span> <span class="o">=</span> <span class="n">energy</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span>


    <span class="k">def</span> <span class="nf">feed_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="n">npimage</span><span class="p">,</span> <span class="n">energy</span> <span class="o">=</span> <span class="n">image</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">GraphicsScene_intensTimeOn</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_scaling</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_size</span> <span class="o">/</span> <span class="n">energy</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">.</span><span class="n">Tracking_minWindowSize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Tracking_minWindowSize</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">GraphicsScene_intensTimeOn</span><span class="p">:</span>
            <span class="n">processNoise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="n">config</span><span class="o">.</span><span class="n">Tracking_processNoisePosition</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">Tracking_processNoisePosition</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">Tracking_processNoiseVelocity</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">Tracking_processNoiseVelocity</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kalman</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">processNoise</span><span class="p">)</span>
        <span class="n">x_p</span><span class="p">,</span> <span class="n">y_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kalman</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="n">guesser</span><span class="p">(</span><span class="n">npimage</span><span class="p">,</span> <span class="n">x_p</span><span class="p">,</span> <span class="n">y_p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">guess</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_th</span><span class="p">,</span> <span class="n">y_th</span><span class="p">,</span> <span class="n">guess_cov</span> <span class="o">=</span> <span class="n">guess</span>
            <span class="c1"># spot in validation region?  (based on residual covariance)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kalman</span><span class="o">.</span><span class="n">measurement_distance</span><span class="p">((</span><span class="n">x_th</span><span class="p">,</span> <span class="n">y_th</span><span class="p">),</span> <span class="n">guess_cov</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">Tracking_gamma</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; No spot in validation gate&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kalman</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">x_th</span><span class="p">,</span> <span class="n">y_th</span><span class="p">],</span> <span class="n">guess_cov</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kalman</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="n">calc_intensity</span><span class="p">(</span><span class="n">npimage</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="n">background_substraction</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">Processing_backgroundSubstractionOn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span></div>

<div class="viewcode-block" id="guess_from_Gaussian"><a class="viewcode-back" href="../../api.html#easyleed.base.guess_from_Gaussian">[docs]</a><span class="k">def</span> <span class="nf">guess_from_Gaussian</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Guess position of spot from a Gaussian fit. &quot;&quot;&quot;</span>
    <span class="c1"># construct circle where data is fit</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="n">calc_distances</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">radius</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">radius</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
    <span class="n">circle</span> <span class="o">=</span> <span class="n">distances</span> <span class="o">&lt;=</span> <span class="n">radius</span><span class="o">**</span><span class="mi">2</span>

    <span class="c1"># generate good guesses for the Gaussian distribution</span>
    <span class="n">background</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">moments</span><span class="p">(</span><span class="n">image</span><span class="o">-</span><span class="n">background</span><span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">background</span><span class="p">)</span>
    <span class="n">errfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">gaussian2d</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">))[</span><span class="n">circle</span><span class="p">]</span> <span class="o">-</span> <span class="n">image</span><span class="p">[</span><span class="n">circle</span><span class="p">])</span>
    <span class="c1"># fit Gaussian</span>
    <span class="n">maxfev</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">leastsq</span><span class="p">(</span><span class="n">errfunc</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="n">maxfev</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">p_opt</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">p_cov</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">infodict</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">infodict</span><span class="p">[</span><span class="s2">&quot;nfev&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">maxfev</span> <span class="ow">or</span> <span class="n">p_cov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Fit failed&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># residual sum of squares sum (x_i - f_i)^2</span>
    <span class="n">sum_of_squares_regression</span> <span class="o">=</span> <span class="p">(</span><span class="n">errfunc</span><span class="p">(</span><span class="n">p_opt</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="c1"># variance of the data sum (x_i - &lt;x&gt;)^2</span>
    <span class="n">sum_of_squares_total</span> <span class="o">=</span> <span class="p">((</span><span class="n">image</span><span class="p">[</span><span class="n">circle</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">circle</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="c1"># calculate R^2</span>
    <span class="n">Rsq</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sum_of_squares_regression</span> <span class="o">/</span> <span class="n">sum_of_squares_total</span>
    <span class="k">if</span> <span class="n">Rsq</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">.</span><span class="n">Tracking_minRsq</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; R^2 too low&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># estimate sigma^2 from a chi^2 equivalent</span>
    <span class="n">s_sq</span> <span class="o">=</span> <span class="n">sum_of_squares_regression</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">circle</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
    <span class="n">p_cov</span> <span class="o">*=</span> <span class="n">s_sq</span>
    <span class="n">p_cov</span> <span class="o">=</span> <span class="n">p_cov</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">x_res</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">y_res</span> <span class="o">=</span> <span class="n">p_opt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x_res</span><span class="p">,</span> <span class="n">y_res</span><span class="p">),</span> <span class="n">p_cov</span></div>

<span class="n">guesser_routines</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Gaussian fit&#39;</span> <span class="p">:</span> <span class="n">guess_from_Gaussian</span><span class="p">}</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">skimage.feature</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;imported scikit image package&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">guess_from_blob_dog</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">blob_dog</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; No blob found&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; Blobs found&#39;</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">guess_from_blob_log</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">blob_log</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; No blob found&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; Blobs found&#39;</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        
    <span class="n">guesser_routines</span><span class="p">[</span><span class="s1">&#39;Blob dog&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">guess_from_blob_dog</span>
    <span class="n">guesser_routines</span><span class="p">[</span><span class="s1">&#39;Blob log&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">guess_from_blob_log</span>

<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">guesser</span><span class="p">(</span><span class="n">npimage</span><span class="p">,</span> <span class="n">x_in</span><span class="p">,</span> <span class="n">y_in</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">failure</span><span class="p">(</span><span class="n">reason</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; No guess, because &quot;</span> <span class="o">+</span> <span class="n">reason</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># try to get patch from image around estimated position</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">func</span><span class="o">=</span><span class="n">guesser_routines</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">Tracking_guessFunc</span><span class="p">]</span>
        <span class="n">fit_region_factor</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">Tracking_fitRegionFactor</span>
        <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">adjust_slice</span><span class="p">(</span><span class="n">npimage</span><span class="p">,</span>
                                                  <span class="n">x_in</span><span class="o">-</span><span class="n">fit_region_factor</span><span class="o">*</span><span class="n">radius</span><span class="p">,</span>
                                                  <span class="n">x_in</span><span class="o">+</span><span class="n">fit_region_factor</span><span class="o">*</span><span class="n">radius</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                                  <span class="n">y_in</span><span class="o">-</span><span class="n">fit_region_factor</span><span class="o">*</span><span class="n">radius</span><span class="p">,</span>
                                                  <span class="n">y_in</span><span class="o">+</span><span class="n">fit_region_factor</span><span class="o">*</span><span class="n">radius</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">failure</span><span class="p">(</span><span class="s2">&quot; Position outside image&quot;</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">npimage</span><span class="p">[</span><span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span><span class="p">,</span> <span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span><span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x_mid</span><span class="o">=</span><span class="n">x_in</span><span class="o">-</span><span class="n">x_min</span><span class="p">,</span> <span class="n">y_mid</span><span class="o">=</span><span class="n">y_in</span><span class="o">-</span><span class="n">y_min</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">radius</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">failure</span><span class="p">(</span><span class="s2">&quot; Fit failed&quot;</span><span class="p">)</span>
    <span class="n">pos</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">result</span>
    <span class="n">y_res</span><span class="p">,</span> <span class="n">x_res</span> <span class="o">=</span> <span class="n">pos</span>
    <span class="n">x_res</span> <span class="o">+=</span> <span class="n">x_min</span>
    <span class="n">y_res</span> <span class="o">+=</span> <span class="n">y_min</span>

    <span class="k">return</span> <span class="n">x_res</span><span class="p">,</span> <span class="n">y_res</span><span class="p">,</span> <span class="n">cov</span>


<div class="viewcode-block" id="gaussian2d"><a class="viewcode-back" href="../../api.html#easyleed.base.gaussian2d">[docs]</a><span class="k">def</span> <span class="nf">gaussian2d</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span><span class="p">,</span> <span class="n">width_x</span><span class="p">,</span> <span class="n">width_y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a two dimensional gaussian function with the given parameters&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">width_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">width_y</span> <span class="o">=</span> <span class="n">width_x</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(((</span><span class="n">center_x</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">width_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                                    <span class="p">((</span><span class="n">center_y</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="n">width_y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> \
                            <span class="n">offset</span></div>


<div class="viewcode-block" id="moments"><a class="viewcode-back" href="../../api.html#easyleed.base.moments">[docs]</a><span class="k">def</span> <span class="nf">moments</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculates the moments of 2d data.</span>
<span class="sd">    Returns [height, x, y, width_x, width_y]</span>
<span class="sd">    the gaussian parameters of a 2D distribution by calculating its</span>
<span class="sd">    moments. &quot;&quot;&quot;</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">total</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">total</span>
    <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span>
    <span class="n">width_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">col</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="p">:]</span>
    <span class="n">width_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">row</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">row</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">height</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width_x</span><span class="p">,</span> <span class="n">width_y</span><span class="p">]</span></div>


<div class="viewcode-block" id="adjust_slice"><a class="viewcode-back" href="../../api.html#easyleed.base.adjust_slice">[docs]</a><span class="k">def</span> <span class="nf">adjust_slice</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">x_sl_min</span><span class="p">,</span> <span class="n">x_sl_max</span><span class="p">,</span> <span class="n">y_sl_min</span><span class="p">,</span> <span class="n">y_sl_max</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adjusts slice if it is trying to get pieces outside the image.</span>

<span class="sd">    &gt;&gt;&gt; image = np.ones((2, 2))</span>
<span class="sd">    &gt;&gt;&gt; adjust_slice(image, 0, 1.5, 0, 2)</span>
<span class="sd">    (0, 1, 0, 2)</span>
<span class="sd">    &gt;&gt;&gt; adjust_slice(image, -5.5, 2, -0.5, 10)</span>
<span class="sd">    (0, 2, 0, 2)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ymax</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">adjusted</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x_sl_min</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">x_sl_max</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y_sl_min</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y_sl_max</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">adjusted</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">xmax</span><span class="p">:</span>
                <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xmax</span>
                <span class="n">adjusted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">ymax</span><span class="p">:</span>
                <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ymax</span>
                <span class="n">adjusted</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">adjusted</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot; slice had to be adjusted to fit image.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">indices</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span></div>


<div class="viewcode-block" id="calc_distances"><a class="viewcode-back" href="../../api.html#easyleed.base.calc_distances">[docs]</a><span class="k">def</span> <span class="nf">calc_distances</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function that returns an array of distances to x, y.</span>
<span class="sd">    This array can be useful for fancy indexing of numpy arrays.</span>

<span class="sd">    squared: return the squared distance (default: True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">yind</span><span class="p">,</span> <span class="n">xind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">distSquare</span> <span class="o">=</span> <span class="p">((</span><span class="n">yind</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">xind</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">squared</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">distSquare</span><span class="o">**.</span><span class="mi">5</span>
    <span class="k">return</span> <span class="n">distSquare</span></div>


<span class="k">def</span> <span class="nf">signal_to_background</span><span class="p">(</span><span class="n">npimage</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
    <span class="n">distSquare</span> <span class="o">=</span> <span class="n">calc_distances</span><span class="p">(</span><span class="n">npimage</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">npimage</span><span class="p">[</span><span class="n">distSquare</span> <span class="o">&lt;=</span> <span class="n">radius</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>
    <span class="c1"># average background intensity over annulus with equal area</span>
    <span class="n">background</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">npimage</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">distSquare</span> <span class="o">&gt;=</span> <span class="n">radius</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">distSquare</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">radius</span><span class="o">**</span><span class="mi">2</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">signal</span><span class="o">/</span><span class="n">background</span>


<div class="viewcode-block" id="calc_intensity"><a class="viewcode-back" href="../../api.html#easyleed.base.calc_intensity">[docs]</a><span class="k">def</span> <span class="nf">calc_intensity</span><span class="p">(</span><span class="n">npimage</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">background_substraction</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">Processing_backgroundSubstractionOn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculates the intensity of a spot.</span>

<span class="sd">        npimage: numpy array of intensity values</span>
<span class="sd">        x, y: position of the spot</span>
<span class="sd">        radius: radius of the spot</span>
<span class="sd">        background_substraction: boolean to turn substraction on/off</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">distSquare</span> <span class="o">=</span> <span class="n">calc_distances</span><span class="p">(</span><span class="n">npimage</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">intensities</span> <span class="o">=</span> <span class="n">npimage</span><span class="p">[</span><span class="n">distSquare</span> <span class="o">&lt;=</span> <span class="n">radius</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">intensities</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">background_substraction</span><span class="p">:</span>
        <span class="c1"># average background intensity over annulus with approximately equal area</span>
        <span class="n">background_intensities</span> <span class="o">=</span> <span class="n">npimage</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">distSquare</span> <span class="o">&gt;=</span> <span class="n">radius</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">distSquare</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">radius</span><span class="o">**</span><span class="mi">2</span><span class="p">)]</span>
        <span class="n">area</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">intensities</span><span class="p">)</span>
        <span class="n">intensity</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">background_intensities</span><span class="p">)</span> <span class="o">*</span> <span class="n">area</span>
    <span class="k">return</span> <span class="n">intensity</span></div>
</pre></div>

            </div>
        </div>
      </div>
      <div class="bottomnav">
      

      </div>

    <a href="http://github.com/andim/easyleed"><img style="position: fixed; top: 0; right: 0; border: 0;"
    src="https://camo.githubusercontent.com/652c5b9acfaddf3a9c326fa6bde407b87f7be0f4/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" /></a>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2010-15, Andreas Mayer, Hanna Salopaasi, Nicola Ferralis.
      Last updated on 2017-11-19.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.
    </div>
  </body>
</html>